#!/bin/bash
#
# This file is released under the GPL Licence version 2 or above
# Please read the Licence Terms at www.gnu.org
# jaromil@dyne.org
#
# /usr/etc/rc.net: Network initialization script.

# /usr/sbin/dhcpcd -t 20 1>/dev/null 2>/dev/null
# as of mant suggestions i received, drazen pantic among the others
# is a better idea to use pump, brings better luck

echo "[*] check for dhcp network"
/usr/sbin/pump -c /usr/etc/pump.conf 1>/dev/null 2>/dev/null

report="`ifconfig | grep -v "127.0.0.1" | grep inet`"
if [ ! -z "$report" ]; then
  echo " .  DHCP network succesfully configured"
fi

# setup hostname from /etc/HOSTNAME or randomize with the eth0 MAC address if needed
if [ -e /etc/HOSTNAME ]; then
    HOSTNAME="`cat /etc/HOSTNAME`"
else
    HOSTNAME="dynebolic`/sbin/ifconfig eth0 2>/dev/null| grep HWaddr | cut -d " "  -f11 | sed 's/[\:\$]//g'`"
fi
# setup the samba name with the assigned hostname
if [ -e /etc/samba/smb.conf ]; then rm -f /etc/samba/smb.conf; fi
sed "s/dynesamba/$HOSTNAME/g" /etc/samba/smb.conf.dist > /etc/samba/smb.conf
hostname "$HOSTNAME"
echo "[*] your hostname is $HOSTNAME"

echo "[*] loading point to point protocol kernel modules"
modprobe -k ppp_generic ppp_async ppp_deflate 1>/dev/null 2>/dev/null
echo "[*] loading iptables nat and masquerading kernel modules"
modprobe -k iptable_filter iptable_nat iptable_mangle

