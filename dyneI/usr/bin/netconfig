#!/bin/bash
#
#
TMP="/tmp"
IFCONFIG=sbin/ifconfig
ROUTE=sbin/route
RC=/var/log/setup/startnet
RESOLV=/var/etc/resolv.conf
HOSTS=/var/etc/hosts
ETCNETWORKS=/var/etc/networks
DHCP=no
IPADDR=127.0.0.1
NETMASK=255.255.255.0
HOSTNM="`cat /etc/HOSTNAME`"

echo "[*] Let's start network configuration ..."

if [ ! "$DISPLAY" ]; then
	echo "[*] Setting console GUI enviroment"
	DIALOG="dialog"
        stparam="--title netconfig --no-shadow"
        shadow="--no-shadow"
        buttons=""
        eofign=""
        timeout=""
        tparam="--timeout 90000"
else
	echo "[*] Setting X-Window GUI enviroment"
        DIALOG="Xdialog"
        stparam="--title netconfig --screen-center"
        shadow=""
        buttons="--no-buttons"
        eofign="--ignore-eof"
        timeout=9000
        tparam=""
fi

if [ ! -d $TMP ]; then
  mkdir -p $TMP
  chmod 700 $TMP
fi

if [ ! -d proc -a ! -d bin -a ! -d tmp ]; then
  cd /
fi

syntax_check_color() {

  RET_CODE=0
  SCRATCH=$1
  SCRATCH=`echo $SCRATCH | tr "." "/"`
  INDEX=$2

	while [ ! "$INDEX" = "0" ]; do
		FIELD=`basename $SCRATCH`
		SCRATCH=`dirname $SCRATCH`
			if expr $FIELD + 1 1> /dev/null 2> /dev/null; then
				GOOD=y
			else
				RET_CODE=2;
			fi

		INDEX=`expr $INDEX - 1`
	done

	if [ ! "$SCRATCH" = "." ]; then
		RET_CODE=1;
	fi

	if [ "$3" = "WARN" -a ! "$RET_CODE" = "0" ]; then
		cat << EOF > $TMP/tempmsg

		The address you have entered seems to be non-standard. We were expecting
		$2 groups of numbers seperated by dots, like: 127.0.0.1
		Are you absolutely sure you want to use the address $1?

EOF

		$DIALOG --title "WARNING" --yesno "`cat $TMP/tempmsg`" 9 72

			if [ $? = 0 ]; then
				RET_CODE=0;
			fi

		rm -r $TMP/tempmsg
	else

		if [ "$3" = "ECHO" ]; then
			echo $RET_CODE;
		fi
	fi

  return $RET_CODE;
}

function staticip(){

while [ 0 ]; do
	if [ -r $TMP/SeTIP ]; then
		IPADDR=`cat $TMP/SeTIP`
	fi

Net01=`$DIALOG --stdout --separator "|" --title "-= Networking Options =-" \
--3inputsbox "Please enter your network configuration parameters for networking" 17 75 \
"IP Address" "192.168.0.254" "Netmask" "255.255.255.0" "Default gateway" "192.168.0.1"`

echo $Net01 | cut -d'|' -f1 > $TMP/SeTlip
echo $Net01 | cut -d'|' -f2 > $TMP/SeTnmask
echo $Net01 | cut -d'|' -f3 > $TMP/SeTgate
	
	if [ $? = 1 -o $? = 255 ]; then
		rm -f $TMP/SeTlip $TMP/SeTgate $TMP/SeTnmask
		exit
	fi

  IPADDR="`cat $TMP/SeTlip`"
  rm -f $TMP/SeTlip

	if [ "$IPADDR" = "" ]; then
		exit -1;
	fi

  syntax_check_color $IPADDR 4 WARN

	if [ $? = 0 ]; then
		echo $IPADDR > $TMP/SeTIP
	fi

  NETMASK="`cat $TMP/SeTnmask`"
  rm -f $TMP/SeTnmask $TMP/tempmsg

	if [ "$NETMASK" = "" ]; then
		continue;
	fi

  syntax_check_color $NETMASK 4 WARN

	if [ $? = 0 ]; then
		echo $NETMASK > $TMP/SeTnetmask
	fi

	if [ -r $TMP/SeTgateway ]; then
		GATEWAY=`cat $TMP/SeTgateway`
	fi

  GATEWAY="`cat $TMP/SeTgate`"
  rm -f $TMP/SeTgate

	if [ "$GATEWAY" = "" ]; then
		continue;
	fi

  syntax_check_color $GATEWAY 4 WARN

	if [ $? = 0 ]; then
		echo $GATEWAY > $TMP/SeTgateway
		break;
	fi

done

}

user=`id -u`

	if [ $user != "0" ]; then
		$DIALOG $stparam $tparam --infobox "No root? no config! :P" 10 00 $timeout
		echo "[*] Network configuration fail"
		exit -1;
	fi

istelnet=`which telnet`

if [ -z "$istelnet" ]; then

tempmsg="You do not seem to have TCP/IP installed, so all I can really set
	 up for you is your hostname/domainname. This won't mean much
	 since you're not on the network, but it will let you have the
	 hostname you prefer shown at the login prompt."

$DIALOG --title "SKIPPING MOST OF THE CONFIG PROCESS" --infobox "$tempmsg" 10 70

fi


tempmsg="A network card has been found on this machine so you can configure
	your TCP/IP to join the LAN you're connected to.

	If you have an assigned IP address, gateway, and DNS, now choose
	'static IP'.

	If your IP address is assigned by a DHCP server (commonly used by
	cable modem, DSL services, local networks), choose 'DHCP'."

what=`$DIALOG $stparam $buttons --stdout --title "Setup network for $HOSTNM" --menu "$tempmsg" 18 65 2\
       "static IP" "Use a static IP address"\
       "DHCP" "Use a DHCP server"`

case "$what" in

	'static IP')
			echo "[*] Setting $what"
			LOOPBACK="no"
			staticip
	;;

	'DHCP')
			echo "[*] Setting $what"
			DHCP="yes"
			for i in `cat /var/run/dhcpd-eth*.pid`; do
				kill -9 $i
			done
			
			rm -rf /var/run/dhcpd*
	;;
	*)
			exit -1
	;;
esac

#let's make rc.* (PORCODIO ...)
/bin/cat << ENDFILE > $RC
#! /bin/sh

HOSTNAME=\`cat /etc/HOSTNAME\`

# Configure the loopback device.
/$IFCONFIG lo 127.0.0.1
/$ROUTE add -net 127.0.0.0 netmask 255.0.0.0 lo

# IF YOU HAVE AN ETHERNET CONNECTION, use these lines below to configure the
# eth0 interface.

# Edit these values to set up a static IP address:
IPADDR="$IPADDR"	# REPLACE with YOUR IP address!
NETMASK="$NETMASK"	# REPLACE with YOUR netmask!
GATEWAY="$GATEWAY"	# REPLACE with YOUR gateway address!

# To use DHCP instead of a static IP, set this value to "yes":
DHCP="$DHCP"            # Use DHCP ("yes" or "no")

# OK, time to set up the interface:
	if [ "\$DHCP" = "yes" ]; then # use DHCP to set everything up:
		echo "Attempting to configure eth0 by contacting a DHCP server..."
		/usr/sbin/dhcpcd
	elif [ ! "\$IPADDR" = "127.0.0.1" ]; then # set up IP statically:
	# Set up the ethernet card:
	echo "Configuring eth0 as \${IPADDR}..."
	/$IFCONFIG eth0 \${IPADDR} netmask \${NETMASK}
  # If that didn't succeed, give the system administrator some hints:
	if [ ! \$? = 0 ]; then
		cat << EOF
Your ethernet card was not initialized properly.  Here are some reasons why this
may have happened, and the solutions:
1. Your kernel does not contain support for your card.  Including all the
   network drivers in a Linux kernel can make it too large to even boot, and
   sometimes including extra drivers can cause system hangs.  To support your
   ethernet, either edit /etc/rc.d/rc.modules to load the support at boottime,
   or compile and install a kernel that contains support.
2. You don't have an ethernet card, in which case you should comment out this
   section of /etc/rc.d/rc.inet1.  (Unless you don't mind seeing this error...)
EOF
	fi

  # If there is a gateway defined, then set it up:
	if [ ! "\$GATEWAY" = "" ]; then
	    /$ROUTE add default gw \${GATEWAY} netmask 0.0.0.0 metric 1
	  fi
	fi

# End of rc.inet1
ENDFILE
chmod 755 $RC

# The Networks file
/bin/cat <<EOF >$ETCNETWORKS
#
# networks	This file describes a number of netname-to-address
#		mappings for the TCP/IP subsystem.  It is mostly
#		used at boot time, when no name servers are running.
#

loopback	127.0.0.0

# End of networks.
EOF
chmod 644 $ETCNETWORKS

# The Hosts File
/bin/cat << EOF > $HOSTS
#
# hosts		This file describes a number of hostname-to-address
#		mappings for the TCP/IP subsystem.  It is mostly
#		used at boot time, when no name servers are running.
#		On small systems, this file can be used instead of a
#		"named" name server.  Just add the names, addresses
#		and any aliases to this file...
#
# By the way, Arnt Gulbrandsen <agulbra@nvg.unit.no> says that 127.0.0.1
# should NEVER be named with the name of the machine.  It causes problems
# for some (stupid) programs, irc and reputedly talk. :^)
#

# For loopbacking.
127.0.0.1	localhost
$IPADDR	 	$HOSTNM

# End of hosts.

EOF
chmod 644 $HOSTS

# Resolv.conf

if [ "$LOOPBACK" = "no" ]; then
 $DIALOG --title "USE A NAMESERVER?" --yesno "Will you be accessing a \
nameserver?" 5 50
 if [ $? = 0 ]; then
  if [ "$GATEWAY" = "" ]; then
    DNSSAMPLE=`echo $IPADDR | cut -f 1-3 -d .`
  else
    DNSSAMPLE=$GATEWAY
  fi
  while [ "$NAMESERVER" = "" ]; do
   cat << EOF > $TMP/tempmsg
Here is your current IP address and base hostname:
$IPADDR       $HOSTNM

Please give the IP address of the name server to use,
such as $DNSSAMPLE.

You can add more Domain Name Servers by editing /$RESOLV.

Name Server for domain $DOMAIN (aaa.bbb.ccc.ddd):
EOF
   $DIALOG --title "SELECT NAMESERVER" --inputbox \
"`cat $TMP/tempmsg`" 16 72 2> $TMP/SeTns
   if [ $? = 1 -o $? = 255 ]; then
    rm -f $TMP/tempmsg $TMP/SeTns 
    break
   fi
   NAMESERVER="`cat $TMP/SeTns`"
   rm -f $TMP/tempmsg $TMP/SeTns
  done
  echo "search $DOMAIN" >$RESOLV
  echo "nameserver $NAMESERVER" >>$RESOLV
 else
  echo "search $DOMAIN" >$RESOLV
 fi
fi
if [ "$LOOPBACK" = "no" ]; then chmod 644 $RESOLV ;fi
#
############################################################################
#		     Change permissions and exit.
############################################################################
#
/var/log/setup/startnet

report="`ifconfig eth0 | grep inet`"
if [ -z "$report" ]; then
  echo "[*] Your network has been succesfully configured"
  if [ $DHCP = "yes" ]; then exit 0; fi

  #save data on a floppy
  floppy=`cat /proc/devices | grep fd`

  if [ -z "$floppy" ]; then
    exit 1
  else
    $DIALOG --title "SAVE DATA TO FLOPPY" --yesno "Would you like to save your actual network configuration to floppy?" 0 0
    if [ $? = 0 ]; then
      /usr/sbin/netfloppy
    fi
  fi
fi

exit 0
